<div class="full-width">
  @if(!levelUpForm) {
    <button [openForm]="openForm" #openForm mat-raised-button color="primary" class="buttons" (click) = openCreateNewLevelUpForm()>Create New Level Up</button>
  } @else {
  <form [formGroup]="levelUpForm" #parentForm='ngForm' (ngSubmit)="createLevelUp()">
    <mat-form-field class="full-width">
      <mat-label>Name*</mat-label>
      <input matInput formControlName="name" [errorStateMatcher]="matcher"/>
    </mat-form-field>

    <mat-form-field class="full-width">
      <mat-label>Icon*</mat-label>
      <mat-select formControlName="icon">
        <mat-option [value]="icon.path" *ngFor="let icon of icons$ | async">{{ icon.name }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field class="full-width">
      <mat-label>Description*</mat-label>
      <textarea matInput formControlName="description"></textarea>
      <mat-hint align="end">Markdown supported</mat-hint>
    </mat-form-field>

    <mat-form-field class="full-width">
      <mat-label>Link</mat-label>
      <input matInput formControlName="link" [errorStateMatcher]="matcher"/>
    </mat-form-field>

    <div class="contentPickerTitle" *ngIf="addedGroups && addedGroups.length">
      <span>Content will be restricted to the following groups:</span>
      <table mat-table class="content-table mat-elevation-z8" [dataSource]="groupDataSource">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef> Group </th>
          <td mat-cell *matCellDef="let group"> {{ group.groupName }} </td>
        </ng-container>

        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef> Action </th>
          <td mat-cell *matCellDef="let group"> 
            <button mat-stroked-button color="error" (click)="deleteGroup(group.groupName)" type="button">Delete</button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedGroupColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedGroupColumns;"></tr>
      </table>
    </div>

    <div class="full-width addContentBlock">
      <mat-form-field class="addCourse">
        <mat-label>Restrict content to group</mat-label>
        <mat-select formControlName="restrictGroup">
          <mat-option [value]="group" *ngFor="let group of groups$ | async">{{ group.groupName }}</mat-option>
        </mat-select>
        <mat-hint align="end">Create new groups by selecting Group above</mat-hint>
      </mat-form-field>
      <button mat-raised-button color="primary" class="addButton" (click)="addGroup()" type="button">Add</button>
    </div>

    <div class="contentPickerTitle" *ngIf="addedCourses && addedCourses.length">
      <span>Courses to be added:</span>
      <table mat-table class="content-table mat-elevation-z8" [dataSource]="courseDataSource">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef> Course </th>
          <td mat-cell *matCellDef="let course"> {{ course.name }} </td>
        </ng-container>

        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef> Action </th>
          <td mat-cell *matCellDef="let course"> 
            <button mat-stroked-button color="error" (click)="deleteCourse(course.courseId)" type="button">Delete</button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedCourseColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedCourseColumns;"></tr>
      </table>
    </div>

    <div class="full-width addContentBlock">
      <mat-form-field class="addCourse">
        <mat-label>Add courses</mat-label>
        <mat-select formControlName="courses">
          <mat-option [value]="course" *ngFor="let course of courses$ | async">{{ course.name }}</mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-raised-button color="primary" class="addButton" (click)="addCourse()" type="button">Add</button>
    </div>

    <mat-form-field class="full-width">
      <mat-label>Add facilitators (list email addresses comma separated)</mat-label>
      <input matInput formControlName="facilitators" [errorStateMatcher]="matcher"/>
    </mat-form-field>
    
    <div class="contentPickerTitle" *ngIf="addedActivities && addedActivities.length">
      <span>Activities to be added:</span>
      <table mat-table class="content-table mat-elevation-z8" [dataSource]="activityDataSource">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef> Activity </th>
          <td mat-cell *matCellDef="let activity"> {{ activity.name }} </td>
        </ng-container>

        <ng-container matColumnDef="duration">
          <th mat-header-cell *matHeaderCellDef> Duration </th>
          <td mat-cell *matCellDef="let activity"> {{ activity.durationInMinutes }} </td>
        </ng-container>

        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef> Date </th>
          <td mat-cell *matCellDef="let activity"> {{ activity.startDate | dateFormat }} </td>
        </ng-container>

        <ng-container matColumnDef="time">
          <th mat-header-cell *matHeaderCellDef> Time </th>
          <td mat-cell *matCellDef="let activity"> {{ activity.startDate | timeFormatNoAdjust }} </td>
        </ng-container>

        <ng-container matColumnDef="facilitators">
          <th mat-header-cell *matHeaderCellDef> Facilitators </th>
          <td mat-cell *matCellDef="let activity"> {{ activity.facilitators }} </td>
        </ng-container>

        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef> Action </th>
          <td mat-cell *matCellDef="let activity"> 
            <button mat-stroked-button color="error" (click)="deleteActivity(activity.levelUpActivityTypeId)" type="button">Delete</button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedActivityColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedActivityColumns;"></tr>
      </table>
    </div>

    <div class="full-width addContentBlock">
      <mat-form-field class="addActivity">
        <mat-label>Add activities</mat-label>
        <mat-select formControlName="activities" [errorStateMatcher]="matcher">
          <mat-option [value]="activity" *ngFor="let activity of activities$ | async">{{ activity.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field class="duration">
        <mat-label>Duration (minutes)</mat-label>
        <input matInput formControlName="duration" [errorStateMatcher]="matcher" />
      </mat-form-field>

      <div class="marginLeft">
        <app-date-time-picker formControlName="startDate" label="Activity"></app-date-time-picker>
      </div>

      <button matTooltip="Add this activity" mat-raised-button color="primary" class="addButton" (click)="addActivity()" type="button">Add</button>
    </div>

    <div class="error" *ngIf="error">
      Please ensure all required fields are filled in and that there are no errors above.
    </div>

    <div class="buttons">
      <button mat-raised-button color="accent" (click) = closeCreateNewLevelUpForm()>Cancel</button>
      @if(levelUpForm.valid && activityDataSource.data.length > 0) {
        <button mat-raised-button color="primary" type="submit">Save</button>
      } @else {
        <!-- save button is not shown to the user -->
      }
    </div>
  </form>
  }
</div>

