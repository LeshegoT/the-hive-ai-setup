<div class="feedback-providers-container">
    <h2 >Assign Feedback Providers for {{this.review.displayName}}</h2>
        <div class="input-container">
            <app-staff-filter 
                (selectStaff)="selectStaff()" 
                searchLabel="Add Feedback Provider" 
                searchType="add"
                [blockBBDEmails]="true">
            </app-staff-filter>
            <button 
                class='add-reviewer-button'
                mat-raised-button
                matTooltip="Add Reviewer" 
                (click)="addReviewerToCreationList()">
            Add {{ this.managerDisplayName$ | async }}
            </button>
        </div>
    <p class="user-tip">Please Note: Add your feedback provider to the list by pressing Enter or + before clicking save</p>
    <div class="mainContent">
    <div class="container">
        <table mat-table class="mat-elevation-z8 full-width-table assignmentTable" [dataSource]="assignmentData">
            
            <ng-container matColumnDef="reviewer">
                <th mat-header-cell *matHeaderCellDef >Feedback Provider </th>
                <td mat-cell *matCellDef="let row; let i = index" >
                    @if(isBBDEmail(row.reviewer)){
                        <details>
                        <summary>
                            {{ row.displayName || row.reviewer }}
                            @if(row.reviewer === this.review.userPrincipleName) {
                                <mat-chip>Self</mat-chip>
                            } @else if(row.reviewer ===this.review.manager){
                                <mat-chip>Reviewer</mat-chip>
                            } @else {
                                <mat-chip>BBD</mat-chip>
                            }
                        </summary>
                            <section id="emailDetailsContainer">
                                <mat-form-field>
                                             <input type="email" matInput placeholder="Client E-mail" [formControl]="emailFormControls[i]"/>
                                    </mat-form-field>
                                    <button *ngIf="!createAssignmentMode" (click)="updateClientEmail(row,i)" [disabled]="!emailFormControls[i].value || emailFormControls[i].invalid || emailFormControls[i].hasError('email') || emailFormControls[i].hasError('bbdEmail')|| !emailFormControls[i]?.value.trim()">+</button>
                                    <div>
                                       @if (emailFormControls[i]?.hasError('email') && emailFormControls[i].touched) {
                                        <mat-error>Please enter email with '&#64;'</mat-error>
                                      } @else if (emailFormControls[i]?.hasError('bbdEmail')) {
                                        <mat-error>BBD email addresses are not allowed for client emails. Please use an external email address.</mat-error>
                                      }
                                    </div>
                            </section>
                    </details>
                    }@else{
                        {{ row.displayName || row.reviewer }}
                        <mat-chip>External</mat-chip>     
                    }
                </td>
            </ng-container>

            <ng-container matColumnDef="deadline">
                <th mat-header-cell *matHeaderCellDef >Deadline</th>
                <td mat-cell *matCellDef="let row">{{row.dueBy | date}}</td>
            </ng-container>

            <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let row">
                <mat-label *ngIf="row.status !== 'Assigned' && row.status!=='Pending Assignment'" class="pendingStatus"><mat-icon>restore</mat-icon> {{row.status}} </mat-label>
                <mat-label *ngIf="row.status === 'Pending Assignment'" class="pendingStatus"><mat-icon>save</mat-icon> {{row.status}} </mat-label>
                <mat-label *ngIf="row.status === 'Assigned'" class="completedStatus"><mat-icon>check_circle_outline</mat-icon> {{row.status}}</mat-label>
            </td>
            </ng-container>

            <ng-container matColumnDef="remove">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let row">
                    <button mat-mini-fab color="accent"  type="button" (click)="removeReviewerFromCreationList(row)" *ngIf="row.status !== 'New'" class="actionBtnSmall reviewActionButton"><mat-icon>delete_outline</mat-icon></button>
                </td>
            </ng-container>

            <ng-container matColumnDef="info">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let row">
                @if(row.status !== 'Pending Assignment') {
                <ng-container *ngFor="let assignment of assignments; trackBy: trackByReviewer">
                    @if(assignment.reviewer === row.reviewer) {
                    <mat-icon
                        color="accent"
                        [matTooltip]="'Assigned by: ' + (assignment.assignedByDisplayName) + 
                        ', Created on: ' + (assignment.createdAt |  date:'yyyy/MM/dd') + 
                        ', Updated on: ' + (assignment.updateDate | date:'yyyy/MM/dd')">
                        info
                    </mat-icon>
                    } @else{
                        <!-- Reviewer does not match this assignment, so no info icon shown -->
                    }
                </ng-container>
                } @else {
                <!-- Hide info icon for Pending Assignments-->
                }
            </td>
            </ng-container>
          

            <tr mat-header-row *matHeaderRowDef="assignmentColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: assignmentColumns;" [ngClass]="!row.reviewer.includes('bbd.co.za') ? 'externalReviewer': ''"></tr>
        </table>
    </div>

        <div class="assignmentButtonPanel">


            <button mat-raised-button color="accent" class="roundedButton" (click)="closeDialog()"><mat-icon>close</mat-icon> Cancel </button>
            <button mat-raised-button class="roundedButton" (click)="saveReviewCreation()" style="background-color: var(--tertiary-color)" [disabled]="!feedbackProviderAdded()"><mat-icon>check</mat-icon> Save </button>
        </div>
    </div>
</div>
