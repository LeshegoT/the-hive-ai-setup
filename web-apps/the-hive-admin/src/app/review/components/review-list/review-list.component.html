<table mat-table class="mat-elevation-z8 full-width-table" [dataSource]="reviewTable" matSort #reviewTableSort="matSort">
    <ng-container matColumnDef="displayName" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Staff Name</th>
        <td mat-cell *matCellDef="let row">
            {{row.displayName}}
            @if (row.staffStatus === "pending-delete") {
              <mat-chip><p class="staff-type-chip">Pending delete</p></mat-chip>
            } @else if (row.staffStatus === "terminated") {
              <mat-chip><p class="staff-type-chip">Terminated</p></mat-chip>
            } @else {
              <!-- We only need to highlight staff members who are pending-delete or are terminated so that we know that their reviews have to be cancelled -->
            }
        </td>
    </ng-container>
    <ng-container matColumnDef="userPrincipleName" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Staff Email</th>
        <td mat-cell *matCellDef="let row">
            {{ row.userPrincipleName}}
            <mat-chip><p class="staff-type-chip">{{row.staffType}}</p></mat-chip>
        </td>
    </ng-container>
    <ng-container matColumnDef="jobTitle" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Job Title</th>
        <td mat-cell *matCellDef="let row">
            {{ row.jobTitle}}
        </td>
    </ng-container>
    <ng-container matColumnDef="manager" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Reviewer</th>
        <td mat-cell *matCellDef="let row">
            {{row.manager}}
        </td>
    </ng-container>
    <ng-container matColumnDef="unit" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Unit</th>
        <td mat-cell *matCellDef="let row">
            {{ row.department}}
        </td>
    </ng-container>
    <ng-container matColumnDef="reviewMonth" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Review Month</th>
        <td mat-cell *matCellDef="let row">
            <section [ngClass]="feedbackService.getReviewDueDateColour(row)" class="review-month" id="dueDateColorIndicator">
                <label  *ngIf="row !== rowCurrentlyBeingEdited">{{ row.dueDate| date:'MMMM'}} {{ row.dueDate| date:'yyyy'}}</label>
                <input #dueBy (change)="currentDateInput($event.target.value)" type="date" *ngIf="row===rowCurrentlyBeingEdited"  matInput value="{{row.dueDate | date:'yyyy-MM-dd'}}"
                    name="dueDate" class="dateInput">
                @if (isOnUpcomingReviews && row !== rowCurrentlyBeingEdited && row.staffType === 'Permanent') {
                    <mat-icon (click)="editFeedback(row)" class="edit-feedback" matTooltip="Edit Date"  matTooltipPosition="right">edit</mat-icon>
                } @else {
                    <!---Date can only be edited for upcoming reviews linked to permanent staff-->
                }
                <mat-icon  (click)="updateAssignmentDate(row)" *ngIf="row===rowCurrentlyBeingEdited" matTooltip="Save Date" matTooltipPosition="right" class="saveIcon">check</mat-icon>
                <mat-icon  (click)="cancelAssignmentUpdate(row)" *ngIf="row===rowCurrentlyBeingEdited" matTooltip="Cancel" matTooltipPosition="right" class="cancelIcon">close</mat-icon>
            </section>
        </td>
    </ng-container>
    <ng-container matColumnDef="previousReviewDate" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Previous Review Date</th>
        <td mat-cell *matCellDef="let row">
            {{ row.dueDate| date }}
        </td>
    </ng-container>
    <ng-container matColumnDef="previousReviewType" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Previous Type</th>
        <td mat-cell *matCellDef="let row">
            {{ row.templateName}}
        </td>
    </ng-container>
    <ng-container matColumnDef="nextReviewDate" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Next Review Date</th>
        <td mat-cell *matCellDef="let row">
            <form [formGroup]="initialiseNextReviewDateFormControl(row.reviewId, row.nextReviewDate)">
                <mat-form-field appearance="outline">
                    <input matInput [min]="minNextReviewDate" [matDatepicker]="pickerFrom" [formControl]="initialiseNextReviewDateFormControl(row.reviewId, row.nextReviewDate)" (dateChange)="updateNextDate($event.value, row)">
                    <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
                    <mat-datepicker #pickerFrom></mat-datepicker>
                    <mat-error>{{ getFormErrors(initialiseNextReviewDateFormControl(row.reviewId, row.nextReviewDate)) }}</mat-error>
                </mat-form-field>
            </form>
        </td>
    </ng-container>
    <ng-container matColumnDef="nextReviewType" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Next Type</th>
        <td mat-cell *matCellDef="let row">
            <mat-form-field appearance="outline">
                            <mat-select [(ngModel)]="row.nextFeedbackTypeId">
                                <mat-option [value]="type.id" *ngFor="let type of reviewTypes">{{ type.name }}</mat-option>
                            </mat-select>
            </mat-form-field>
        </td>
    </ng-container>
    <ng-container matColumnDef="reviewDate" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Feedback Due Date</th>
        <td mat-cell *matCellDef="let row">
            {{ row.feedbackDate | date }}
        </td>
    </ng-container>
     <ng-container matColumnDef="type" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
        <td mat-cell *matCellDef="let row">
            <section class="review-type">
                @if (row !== typeCurrentlyBeingEdited) {
                    <p>{{row.templateName}}</p>
                } @else {
                    <!--Does not display when the review type is being edited-->
                }
                <mat-icon   (click)="showReviewTypeOptions(row)" *ngIf="isOnUpcomingReviews && row !==typeCurrentlyBeingEdited" class="edit-feedback" matTooltip="Edit Review Type"  matTooltipPosition="right" >edit</mat-icon>
                <mat-form-field appearance="outline" *ngIf="row === typeCurrentlyBeingEdited" >
                    <mat-select  (focusout)="show=false" [(ngModel)]="row.templateName" *ngIf="row === typeCurrentlyBeingEdited" (selectionChange)="updateReviewType(row,$event)">
                        <mat-option [value]="type.name" *ngFor="let type of reviewTypes">{{ type.name }}</mat-option>
                    </mat-select>
                </mat-form-field>
                @if (isOnUpcomingReviews && row === typeCurrentlyBeingEdited) {
                    <mat-icon (click)="cancelUpdateReviewType()" matTooltip="Cancel update" matTooltipPosition="right" class="cancelIcon">close</mat-icon>
                } @else {
                    <!--Cancel button does not display because review type is not being edited-->
                }
            </section>
        </td>
    </ng-container>
    <ng-container matColumnDef="hrRep" >
      <th mat-header-cell *matHeaderCellDef mat-sort-header>HR Rep</th>
      <td mat-cell *matCellDef="let row">
          {{ row.hrRep ?? '(Not assigned)' }}
      </td>
  </ng-container>
  <ng-container matColumnDef="updatedDate" >
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Last Status Change</th>
    <td mat-cell *matCellDef="let row">
        {{ row.updatedDate | date }}
    </td>
</ng-container>
    <ng-container matColumnDef="controls" >
        <th mat-header-cell *matHeaderCellDef mat-sort-header></th>
        <td mat-cell *matCellDef="let row">
            <div class="buttonContainer">
                <button (click)="actionButtonTask(row, $event)" *ngIf="buttonsEnabled && makeActionButtonText(row) && actionButtonIconName" class="actionBtnSmall reviewActionButton" id="actionButton{{row.reviewId}}" title="{{makeActionButtonText(row)}}" [disabled]="row.holdReason || actionButtonsDisabled"><mat-icon>{{actionButtonIconName}}</mat-icon></button>
                @if (displayNudgeButton){
                    <button type="button" class="notesBtnSmall reviewActionButton"
                        (click)="nudgeManager(row, $event)"
                        title="Send reminder">
                        <mat-icon>send</mat-icon>
                    </button>
                } @else {
                    <!-- review is not in Feedback requested status. don't display nudge button -->
                }
                <button (click)="downloadReport(row)" *ngIf="showDownloadReportButton" class="notesBtnSmall reviewActionButton" id="downloadReportButton{{row.reviewId}}" [title]="row.requiresFeedback ? 'Download Report':'No feedback to download for this review'" [disabled]="row.holdReason || (!row.requiresFeedback)"><mat-icon>save_alt</mat-icon></button>
                <button *ngIf="showHrNotesButton" (click)="hrNotes(row)" class="notesBtnSmall reviewActionButton" title="Review Notes" [disabled]="hrNotesButtonsDisabled"><mat-icon>chat_bubble_outline</mat-icon></button>
                @if (buttonsEnabled && showMoveToFeedbackCompletedButton && !row.hasFeedbackInProgress && feedbackCompletedReviewStatusId) {
                    <button (click)="moveReviewToFeedbackCompletedStatus(row)" class="notesBtnSmall reviewActionButton" title="Move to completed"><mat-icon>task_alt</mat-icon></button>
                } @else {
                    <!-- The 'Move to Feedback Completed' button is not displayed. -->
                }
                <button (click)="cancelReview(row)" *ngIf="buttonsEnabled && cancelButtonText" class="cancelBtnSmall reviewActionButton" id= "cancelButton{{row.reviewId}}" title="{{cancelButtonText}}" [disabled]="deleteButtonsDisabled"><mat-icon>delete_outline</mat-icon></button>
                <button (click)="holdButtonTask(row, $event)" *ngIf="showHoldButton" class="reviewActionButton" [ngClass]="row.holdReason ? 'releaseBtnSmall' : 'cancelBtnSmall'" id= "cancelButton{{row.staffReviewId}}" title="{{row.holdReason ?'Release Hold' : 'Hold'}}"><mat-icon>{{row.holdReason ? 'play_arrow' : 'pause'}}</mat-icon></button>
                <button (click)="showReviewMeetingMinutesDialog(row)" *ngIf="buttonsEnabled && showReviewMeetingMinutesButton" class="notesBtnSmall reviewActionButton" title="Review Meeting Minutes"><mat-icon>note_add</mat-icon></button>
                <button (click)="archiveButtonTask(row, $event)" *ngIf="buttonsEnabled && showArchiveButton" class="notesBtnSmall reviewActionButton" title="Archive Review" id= "archiveButton{{row.reviewId}}"><mat-icon>shelves</mat-icon></button>
                <button *ngIf="row.holdReason" (click)="showHoldReason(row)" class="notesBtnSmall reviewActionButton" title="Hold Reason"><mat-icon>comment</mat-icon></button>
                <button *ngIf="canReviewBeStolen(row)" (click)="stealFeedbackAssignment(row)" class="notesBtnSmall reviewActionButton" title="Take Review"><mat-icon>transfer_within_a_station</mat-icon></button>
                <button *ngIf="buttonsEnabled && showBackToInProgressButton" (click)="takeReviewBackToInProgressTask(row)" class="notesBtnSmall reviewActionButton" title="Back to In Progress"><mat-icon>restart_alt</mat-icon></button>

                @if(buttonsEnabled && showBackToExecFeedbackReceivedButton){
                <button (click)="takeReviewBakToExecFeedbackReceivedTask(row)" class="notesBtnSmall reviewActionButton" title="Back to STRATCO Feedback Received"><mat-icon>restart_alt</mat-icon></button>
                }@else{
                <!-- The 'Back to STRATCO Feedback Received' button is not displayed. -->
                }
                 @if(buttonsEnabled && showBackToExecFeedbackRequestedButton){
                <button (click)="takeReviewBackToExecFeedbackRequestedTask(row)" class="notesBtnSmall reviewActionButton" title="Back to Summary sent to STRATCO"><mat-icon>restart_alt</mat-icon></button>
                }@else{
                <!-- The 'Back to Summary sent to STRATCO' button is not displayed. -->
                }

                @if (buttonsEnabled && showMarkAsPendingDeleteButton) {
                  <app-mark-staff-member-for-termination-action
                    [userPrincipalName]="row.userPrincipleName"
                    [skipActiveReviewsCheck]="true"
                    (staffMemberMarkedForTermination)="onStaffMemberMarkedForTermination(row)">
                  </app-mark-staff-member-for-termination-action>
                } @else {
                  <!-- The parent component is not showing the mark as pending delete button. -->
                }

                @if (row.reviewId && (canViewReviewAudit(row.reviewId) | async)) {
                  <button mat-icon-button (click)="showReviewAuditDialog(row)" matTooltip="View review history">
                    <mat-icon>history</mat-icon>
                  </button>
                } @else {
                  <!-- The reviewId is not available or this user does not have permission to view audit history, don't show the audit history button -->
                }
            </div>
        </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="reviewColumns; sticky: true"></tr>
    <tr mat-row *matRowDef="let row; columns: reviewColumns;" (click)="rowSelectTask(row)" [ngClass]="isRowSelectable ? 'selectable-row': ''" id= "{{row.reviewId}}"></tr>
</table>
<section class="loading" *ngIf="!reviewData"><mat-spinner></mat-spinner></section>
<section class="noDataToDisplayLabel" *ngIf="reviewData && reviewTable.filteredData.length === 0"><label>There are no reviews to show</label></section>
